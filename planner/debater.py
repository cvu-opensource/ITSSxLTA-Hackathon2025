import os
from dotenv import load_dotenv

import requests

load_dotenv()


class LLMDebater:
    """
    A class that facilitates a debate between 2 LLMs to propose and analyse possible solutions
    """

    def __init__(self, model_url):
        self.model_url = model_url
        self.generator_persona = 'Urban Traffic Engineer, focusing on finding the most effective, cost-effective and quick solutions.'
        self.discriminator_persona = 'AI Traffic Analyst, emphasizing efficiency, safety, and long-term sustainability of proposed plans.'

        self.conversation_history = []

    def generate_response(self, role: str, context: str, message: str) -> str:
        """
        Structured method to call the LLM and return a response
        """
        prompt = f"Your role is: {role}\n\nThis is the context: {context}\n\nDo this: {message}\nResponse:"
        try:
            response = requests.post(
                self.model_url,
                json={
                    "model": "deepseek-chat",
                    "messages": [
                        {"role": "user", "content": prompt}
                    ],
                    "temperature": 0.7},
                timeout=10  # Set timeout for better handling
            )
            response.raise_for_status()
            return response.json().get("choices", [{}])[0].get("message", {}).get("content", "").strip()
        except Exception as e:
            return f"Error communicating with local model: {e}"

    def debate(self, traffic_data, graph_context, max_rounds=3):
        """
        Orchestrates a structured debate between two LLMs
        
        Args:
            traffic_data [dict]: Dict containing accident and congestion records
            graph_context [str]: String representation of the traffic network graph
            max_rounds [int]: Maximum number of debate rounds
            
        Returns:
            List of conversation exchanges.
        """
        # Format the initial problem statement
        problem_statement = (
            f"Traffic Data: {traffic_data}\n\n"
            f"Graph Context: {graph_context}\n\n"
            "Discuss and propose solutions to reduce accident rates and traffic congestion in the network."
        )
        specifications = 'Keep your responses clear and concised, always following a structured manner.'

        message = "Start the discussion by proposing a solution to reduce traffic congestion and accidents in the proposed region."
        for round_num in range(max_rounds):
            # LLM 1 proposes a solution
            response1 = self.generate_response(self.persona1, problem_statement, message + specifications)
            self.conversation_history.append({"role": "LLM1", "content": response1})
            
            # LLM 2 critiques and refines the solution
            message = f'Generate critique for this solution and refine it: {response1}\n'
            response2 = self.generate_response(self.persona2, problem_statement, message + specifications)
            self.conversation_history.append({"role": "LLM2", "content": response2})
            
            # Update the message for the next round
            message = f"Refined solution so far: {response2}\nFurther improve or debate this."

        return self.conversation_history

def main():
    debater = LLMDebater()

    received_data = [
        {
            "location": "TPE(PIE) - Exit 2 to Loyang Ave",
            "average_pixel_speed": 4.5e-05,
            "average_traffic_density": 0.0,
            "average_vehicles": 9.2,
            "accidents": {
                "2025-03-26T10:51:02",
                "2025-03-26T10:20:41",
                "2025-03-26T10:45:42",
                "2025-03-26T10:35:42",
                "2025-03-26T01:20:41",
                "2025-03-25T22:15:53",
                "2025-03-26T10:06:01",
                "2025-03-26T10:10:41",
                "2025-03-26T02:25:43",
                "2025-03-26T10:31:02",
                "2025-03-26T10:40:42",
                "2025-03-26T08:35:58",
                "2025-03-25T23:20:36",
                "2025-03-26T10:15:41",
                "2025-03-26T10:25:42",
            },
        },
        {
            "location": "TPE(PIE) - Tampines Viaduct",
            "average_pixel_speed": 8.8e-05,
            "average_traffic_density": 0.0,
            "average_vehicles": 20.066667,
            "accidents": {
                "2025-03-26T10:51:02",
                "2025-03-26T10:20:41",
                "2025-03-26T10:45:42",
                "2025-03-26T10:35:42",
                "2025-03-26T01:20:41",
                "2025-03-25T22:15:53",
                "2025-03-26T10:06:01",
                "2025-03-26T10:10:41",
                "2025-03-26T02:25:43",
                "2025-03-26T10:31:02",
                "2025-03-26T10:40:42",
                "2025-03-26T08:35:58",
                "2025-03-25T23:20:36",
                "2025-03-26T10:15:41",
                "2025-03-26T10:25:42",
            },
        },
        {
            "location": "Tanah Merah Coast Road towards Changi",
            "average_pixel_speed": 6e-05,
            "average_traffic_density": 0.0,
            "average_vehicles": 4.529412,
            "accidents": {
                "2025-03-26T10:51:02",
                "2025-03-26T10:20:41",
                "2025-03-26T10:45:42",
                "2025-03-26T10:35:42",
                "2025-03-26T07:30:36",
                "2025-03-26T00:15:38",
                "2025-03-26T03:20:46",
                "2025-03-25T23:10:36",
                "2025-03-25T20:05:48",
                "2025-03-26T09:31:00",
                "2025-03-26T10:06:01",
                "2025-03-26T10:10:41",
                "2025-03-26T10:31:02",
                "2025-03-26T10:40:42",
                "2025-03-26T02:15:43",
                "2025-03-26T10:15:41",
                "2025-03-26T10:25:42",
            },
        },
        {
            "location": "TPE (PIE) - Upper Changi F/O",
            "average_pixel_speed": 0.051769,
            "average_traffic_density": 0.458262,
            "average_vehicles": 6.283333,
            "accidents": {
                "2025-03-26T10:35:42",
                "2025-03-26T03:25:46",
                "2025-03-26T03:10:45",
                "2025-03-26T03:20:46",
                "2025-03-26T03:55:47",
                "2025-03-26T01:30:41",
                "2025-03-26T02:10:43",
                "2025-03-26T01:56:02",
                "2025-03-26T01:10:40",
                "2025-03-26T02:35:44",
                "2025-03-25T23:05:55",
                "2025-03-26T10:15:41",
                "2025-03-26T03:35:46",
                "2025-03-26T09:45:40",
                "2025-03-26T03:05:45",
                "2025-03-26T10:20:41",
                "2025-03-26T03:45:47",
                "2025-03-26T02:45:44",
                "2025-03-26T02:00:42",
                "2025-03-26T01:50:42",
                "2025-03-26T02:40:44",
                "2025-03-25T22:40:54",
                "2025-03-26T09:20:39",
                "2025-03-26T09:31:00",
                "2025-03-26T02:05:43",
                "2025-03-26T09:26:00",
                "2025-03-26T02:15:43",
                "2025-03-26T02:25:43",
                "2025-03-26T10:25:42",
                "2025-03-26T09:56:01",
                "2025-03-26T03:30:46",
                "2025-03-26T01:05:40",
                "2025-03-26T10:45:42",
                "2025-03-26T03:50:47",
                "2025-03-26T09:40:40",
                "2025-03-26T01:40:42",
                "2025-03-26T02:30:44",
                "2025-03-26T10:06:01",
                "2025-03-26T01:25:41",
                "2025-03-26T10:31:02",
                "2025-03-26T10:40:42",
                "2025-03-26T09:36:00",
                "2025-03-26T10:01:01",
                "2025-03-26T09:10:59",
                "2025-03-26T01:45:42",
                "2025-03-25T23:15:56",
                "2025-03-26T10:51:02",
                "2025-03-25T23:00:35",
                "2025-03-26T02:55:45",
                "2025-03-26T01:20:41",
                "2025-03-26T03:15:45",
                "2025-03-26T10:10:41",
                "2025-03-26T01:35:41",
                "2025-03-25T22:50:35",
                "2025-03-26T02:20:43",
                "2025-03-26T03:40:46",
                "2025-03-26T00:50:40",
                "2025-03-26T03:00:45",
                "2025-03-26T02:50:44",
                "2025-03-26T09:51:00",
                "2025-03-26T09:15:59",
                "2025-03-26T00:56:00",
            },
        },
        {
            "location": "TPE(PIE) - Entrance to PIE from Tampines Ave 10",
            "average_pixel_speed": 0.091703,
            "average_traffic_density": 1.211992,
            "average_vehicles": 9.466667,
            "accidents": {
                "2025-03-26T10:35:42",
                "2025-03-26T03:25:46",
                "2025-03-26T03:10:45",
                "2025-03-26T03:20:46",
                "2025-03-26T03:55:47",
                "2025-03-26T01:30:41",
                "2025-03-26T02:10:43",
                "2025-03-26T01:56:02",
                "2025-03-26T01:10:40",
                "2025-03-26T02:35:44",
                "2025-03-25T23:05:55",
                "2025-03-26T10:15:41",
                "2025-03-26T03:35:46",
                "2025-03-26T09:45:40",
                "2025-03-26T03:05:45",
                "2025-03-26T10:20:41",
                "2025-03-26T03:45:47",
                "2025-03-26T02:45:44",
                "2025-03-26T02:00:42",
                "2025-03-26T01:50:42",
                "2025-03-26T02:40:44",
                "2025-03-25T22:40:54",
                "2025-03-26T09:20:39",
                "2025-03-26T09:31:00",
                "2025-03-26T02:05:43",
                "2025-03-26T09:26:00",
                "2025-03-26T02:15:43",
                "2025-03-26T02:25:43",
                "2025-03-26T10:25:42",
                "2025-03-26T09:56:01",
                "2025-03-26T03:30:46",
                "2025-03-26T01:05:40",
                "2025-03-26T10:45:42",
                "2025-03-26T03:50:47",
                "2025-03-26T09:40:40",
                "2025-03-26T01:40:42",
                "2025-03-26T02:30:44",
                "2025-03-26T10:06:01",
                "2025-03-26T01:25:41",
                "2025-03-26T10:31:02",
                "2025-03-26T10:40:42",
                "2025-03-26T09:36:00",
                "2025-03-26T10:01:01",
                "2025-03-26T09:10:59",
                "2025-03-26T01:45:42",
                "2025-03-25T23:15:56",
                "2025-03-26T10:51:02",
                "2025-03-25T23:00:35",
                "2025-03-26T02:55:45",
                "2025-03-26T01:20:41",
                "2025-03-26T03:15:45",
                "2025-03-26T10:10:41",
                "2025-03-26T01:35:41",
                "2025-03-25T22:50:35",
                "2025-03-26T02:20:43",
                "2025-03-26T03:40:46",
                "2025-03-26T00:50:40",
                "2025-03-26T03:00:45",
                "2025-03-26T02:50:44",
                "2025-03-26T09:51:00",
                "2025-03-26T09:15:59",
                "2025-03-26T00:56:00",
            },
        },
        {
            "location": "TPE(SLE) - TPE Exit KPE",
            "average_pixel_speed": 0.034899,
            "average_traffic_density": 0.269055,
            "average_vehicles": 7.316667,
            "accidents": {
                "2025-03-26T10:35:42",
                "2025-03-26T03:25:46",
                "2025-03-26T03:10:45",
                "2025-03-26T03:20:46",
                "2025-03-26T03:55:47",
                "2025-03-26T01:30:41",
                "2025-03-26T02:10:43",
                "2025-03-26T01:56:02",
                "2025-03-26T01:10:40",
                "2025-03-26T02:35:44",
                "2025-03-25T23:05:55",
                "2025-03-26T10:15:41",
                "2025-03-26T03:35:46",
                "2025-03-26T09:45:40",
                "2025-03-26T03:05:45",
                "2025-03-26T10:20:41",
                "2025-03-26T03:45:47",
                "2025-03-26T02:45:44",
                "2025-03-26T02:00:42",
                "2025-03-26T01:50:42",
                "2025-03-26T02:40:44",
                "2025-03-25T22:40:54",
                "2025-03-26T09:20:39",
                "2025-03-26T09:31:00",
                "2025-03-26T02:05:43",
                "2025-03-26T09:26:00",
                "2025-03-26T02:15:43",
                "2025-03-26T02:25:43",
                "2025-03-26T10:25:42",
                "2025-03-26T09:56:01",
                "2025-03-26T03:30:46",
                "2025-03-26T01:05:40",
                "2025-03-26T10:45:42",
                "2025-03-26T03:50:47",
                "2025-03-26T09:40:40",
                "2025-03-26T01:40:42",
                "2025-03-26T02:30:44",
                "2025-03-26T10:06:01",
                "2025-03-26T01:25:41",
                "2025-03-26T10:31:02",
                "2025-03-26T10:40:42",
                "2025-03-26T09:36:00",
                "2025-03-26T10:01:01",
                "2025-03-26T09:10:59",
                "2025-03-26T01:45:42",
                "2025-03-25T23:15:56",
                "2025-03-26T10:51:02",
                "2025-03-25T23:00:35",
                "2025-03-26T02:55:45",
                "2025-03-26T01:20:41",
                "2025-03-26T03:15:45",
                "2025-03-26T10:10:41",
                "2025-03-26T01:35:41",
                "2025-03-25T22:50:35",
                "2025-03-26T02:20:43",
                "2025-03-26T03:40:46",
                "2025-03-26T00:50:40",
                "2025-03-26T03:00:45",
                "2025-03-26T02:50:44",
                "2025-03-26T09:51:00",
                "2025-03-26T09:15:59",
                "2025-03-26T00:56:00",
            },
        },
        {
            "location": "TPE(PIE) - Entrance from Tampines FO",
            "average_pixel_speed": 0.040936,
            "average_traffic_density": 0.325668,
            "average_vehicles": 8.9,
            "accidents": {
                "2025-03-26T10:35:42",
                "2025-03-26T03:25:46",
                "2025-03-26T03:10:45",
                "2025-03-26T03:20:46",
                "2025-03-26T03:55:47",
                "2025-03-26T01:30:41",
                "2025-03-26T02:10:43",
                "2025-03-26T01:56:02",
                "2025-03-26T01:10:40",
                "2025-03-26T02:35:44",
                "2025-03-25T23:05:55",
                "2025-03-26T10:15:41",
                "2025-03-26T03:35:46",
                "2025-03-26T09:45:40",
                "2025-03-26T03:05:45",
                "2025-03-26T10:20:41",
                "2025-03-26T03:45:47",
                "2025-03-26T02:45:44",
                "2025-03-26T02:00:42",
                "2025-03-26T01:50:42",
                "2025-03-26T02:40:44",
                "2025-03-25T22:40:54",
                "2025-03-26T09:20:39",
                "2025-03-26T09:31:00",
                "2025-03-26T02:05:43",
                "2025-03-26T09:26:00",
                "2025-03-26T02:15:43",
                "2025-03-26T02:25:43",
                "2025-03-26T10:25:42",
                "2025-03-26T09:56:01",
                "2025-03-26T03:30:46",
                "2025-03-26T01:05:40",
                "2025-03-26T10:45:42",
                "2025-03-26T03:50:47",
                "2025-03-26T09:40:40",
                "2025-03-26T01:40:42",
                "2025-03-26T02:30:44",
                "2025-03-26T10:06:01",
                "2025-03-26T01:25:41",
                "2025-03-26T10:31:02",
                "2025-03-26T10:40:42",
                "2025-03-26T09:36:00",
                "2025-03-26T10:01:01",
                "2025-03-26T09:10:59",
                "2025-03-26T01:45:42",
                "2025-03-25T23:15:56",
                "2025-03-26T10:51:02",
                "2025-03-25T23:00:35",
                "2025-03-26T02:55:45",
                "2025-03-26T01:20:41",
                "2025-03-26T03:15:45",
                "2025-03-26T10:10:41",
                "2025-03-26T01:35:41",
                "2025-03-25T22:50:35",
                "2025-03-26T02:20:43",
                "2025-03-26T03:40:46",
                "2025-03-26T00:50:40",
                "2025-03-26T03:00:45",
                "2025-03-26T02:50:44",
                "2025-03-26T09:51:00",
                "2025-03-26T09:15:59",
                "2025-03-26T00:56:00",
            },
        },
        {
            "location": "TPE(SLE) - On rooflp of Blk 189A Rivervale Drive 9",
            "average_pixel_speed": 0.063202,
            "average_traffic_density": 0.660602,
            "average_vehicles": 8.533333,
            "accidents": {
                "2025-03-26T10:35:42",
                "2025-03-26T03:25:46",
                "2025-03-26T03:10:45",
                "2025-03-26T03:20:46",
                "2025-03-26T03:55:47",
                "2025-03-26T01:30:41",
                "2025-03-26T02:10:43",
                "2025-03-26T01:56:02",
                "2025-03-26T01:10:40",
                "2025-03-26T02:35:44",
                "2025-03-25T23:05:55",
                "2025-03-26T10:15:41",
                "2025-03-26T03:35:46",
                "2025-03-26T09:45:40",
                "2025-03-26T03:05:45",
                "2025-03-26T10:20:41",
                "2025-03-26T03:45:47",
                "2025-03-26T02:45:44",
                "2025-03-26T02:00:42",
                "2025-03-26T01:50:42",
                "2025-03-26T02:40:44",
                "2025-03-25T22:40:54",
                "2025-03-26T09:20:39",
                "2025-03-26T09:31:00",
                "2025-03-26T02:05:43",
                "2025-03-26T09:26:00",
                "2025-03-26T02:15:43",
                "2025-03-26T02:25:43",
                "2025-03-26T10:25:42",
                "2025-03-26T09:56:01",
                "2025-03-26T03:30:46",
                "2025-03-26T01:05:40",
                "2025-03-26T10:45:42",
                "2025-03-26T03:50:47",
                "2025-03-26T09:40:40",
                "2025-03-26T01:40:42",
                "2025-03-26T02:30:44",
                "2025-03-26T10:06:01",
                "2025-03-26T01:25:41",
                "2025-03-26T10:31:02",
                "2025-03-26T10:40:42",
                "2025-03-26T09:36:00",
                "2025-03-26T10:01:01",
                "2025-03-26T09:10:59",
                "2025-03-26T01:45:42",
                "2025-03-25T23:15:56",
                "2025-03-26T10:51:02",
                "2025-03-25T23:00:35",
                "2025-03-26T02:55:45",
                "2025-03-26T01:20:41",
                "2025-03-26T03:15:45",
                "2025-03-26T10:10:41",
                "2025-03-26T01:35:41",
                "2025-03-25T22:50:35",
                "2025-03-26T02:20:43",
                "2025-03-26T03:40:46",
                "2025-03-26T00:50:40",
                "2025-03-26T03:00:45",
                "2025-03-26T02:50:44",
                "2025-03-26T09:51:00",
                "2025-03-26T09:15:59",
                "2025-03-26T00:56:00",
            },
        },
        {
            "location": "TPE(PIE) - Seletar Flyover",
            "average_pixel_speed": 0.03,
            "average_traffic_density": 0.262655,
            "average_vehicles": 8.733333,
            "accidents": {
                "2025-03-26T10:35:42",
                "2025-03-26T03:25:46",
                "2025-03-26T03:10:45",
                "2025-03-26T03:20:46",
                "2025-03-26T03:55:47",
                "2025-03-26T01:30:41",
                "2025-03-26T02:10:43",
                "2025-03-26T01:56:02",
                "2025-03-26T01:10:40",
                "2025-03-26T02:35:44",
                "2025-03-25T23:05:55",
                "2025-03-26T10:15:41",
                "2025-03-26T03:35:46",
                "2025-03-26T09:45:40",
                "2025-03-26T03:05:45",
                "2025-03-26T10:20:41",
                "2025-03-26T03:45:47",
                "2025-03-26T02:45:44",
                "2025-03-26T02:00:42",
                "2025-03-26T01:50:42",
                "2025-03-26T02:40:44",
                "2025-03-25T22:40:54",
                "2025-03-26T09:20:39",
                "2025-03-26T09:31:00",
                "2025-03-26T02:05:43",
                "2025-03-26T09:26:00",
                "2025-03-26T02:15:43",
                "2025-03-26T02:25:43",
                "2025-03-26T10:25:42",
                "2025-03-26T09:56:01",
                "2025-03-26T03:30:46",
                "2025-03-26T01:05:40",
                "2025-03-26T10:45:42",
                "2025-03-26T03:50:47",
                "2025-03-26T09:40:40",
                "2025-03-26T01:40:42",
                "2025-03-26T02:30:44",
                "2025-03-26T10:06:01",
                "2025-03-26T01:25:41",
                "2025-03-26T10:31:02",
                "2025-03-26T10:40:42",
                "2025-03-26T09:36:00",
                "2025-03-26T10:01:01",
                "2025-03-26T09:10:59",
                "2025-03-26T01:45:42",
                "2025-03-25T23:15:56",
                "2025-03-26T10:51:02",
                "2025-03-25T23:00:35",
                "2025-03-26T02:55:45",
                "2025-03-26T01:20:41",
                "2025-03-26T03:15:45",
                "2025-03-26T10:10:41",
                "2025-03-26T01:35:41",
                "2025-03-25T22:50:35",
                "2025-03-26T02:20:43",
                "2025-03-26T03:40:46",
                "2025-03-26T00:50:40",
                "2025-03-26T03:00:45",
                "2025-03-26T02:50:44",
                "2025-03-26T09:51:00",
                "2025-03-26T09:15:59",
                "2025-03-26T00:56:00",
            },
        },
        {
            "location": "TPE(SLE) - LP790F (On SLE Flyover)",
            "average_pixel_speed": 0.043413,
            "average_traffic_density": 0.621325,
            "average_vehicles": 8.733333,
            "accidents": {
                "2025-03-26T10:35:42",
                "2025-03-26T03:25:46",
                "2025-03-26T03:10:45",
                "2025-03-26T03:20:46",
                "2025-03-26T03:55:47",
                "2025-03-26T01:30:41",
                "2025-03-26T02:10:43",
                "2025-03-26T01:56:02",
                "2025-03-26T01:10:40",
                "2025-03-26T02:35:44",
                "2025-03-25T23:05:55",
                "2025-03-26T10:15:41",
                "2025-03-26T03:35:46",
                "2025-03-26T09:45:40",
                "2025-03-26T03:05:45",
                "2025-03-26T10:20:41",
                "2025-03-26T03:45:47",
                "2025-03-26T02:45:44",
                "2025-03-26T02:00:42",
                "2025-03-26T01:50:42",
                "2025-03-26T02:40:44",
                "2025-03-25T22:40:54",
                "2025-03-26T09:20:39",
                "2025-03-26T09:31:00",
                "2025-03-26T02:05:43",
                "2025-03-26T09:26:00",
                "2025-03-26T02:15:43",
                "2025-03-26T02:25:43",
                "2025-03-26T10:25:42",
                "2025-03-26T09:56:01",
                "2025-03-26T03:30:46",
                "2025-03-26T01:05:40",
                "2025-03-26T10:45:42",
                "2025-03-26T03:50:47",
                "2025-03-26T09:40:40",
                "2025-03-26T01:40:42",
                "2025-03-26T02:30:44",
                "2025-03-26T10:06:01",
                "2025-03-26T01:25:41",
                "2025-03-26T10:31:02",
                "2025-03-26T10:40:42",
                "2025-03-26T09:36:00",
                "2025-03-26T10:01:01",
                "2025-03-26T09:10:59",
                "2025-03-26T01:45:42",
                "2025-03-25T23:15:56",
                "2025-03-26T10:51:02",
                "2025-03-25T23:00:35",
                "2025-03-26T02:55:45",
                "2025-03-26T01:20:41",
                "2025-03-26T03:15:45",
                "2025-03-26T10:10:41",
                "2025-03-26T01:35:41",
                "2025-03-25T22:50:35",
                "2025-03-26T02:20:43",
                "2025-03-26T03:40:46",
                "2025-03-26T00:50:40",
                "2025-03-26T03:00:45",
                "2025-03-26T02:50:44",
                "2025-03-26T09:51:00",
                "2025-03-26T09:15:59",
                "2025-03-26T00:56:00",
            },
        },
    ]

    graph_context = "Graph of roads, intersections, and congestion data."

    result = debater.debate(received_data, graph_context, max_rounds=5)
    
    for entry in result:
        print(f"{entry['role']}: {entry['content']}\n")


if __name__=='__main__':
    main()
